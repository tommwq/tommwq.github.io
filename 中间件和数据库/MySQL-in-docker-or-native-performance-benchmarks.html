<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-23 周一 18:45 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<p>
docker中的MySQL:性能测试
</p>

<p>
早在10月份我写了几种在一台机器上运行多个MySQL实例的几种可行方法。几个月来，将我们数据库拆分成独立实力的工作已经结束。我开始尝试不同的方案。
</p>

<p>
我开始使用docker，由于我们的应用程序会使用容器，加上我认为保持基础设施分散性最低是一个好想法。我使用docker的官方Percona镜像，这个镜像易用和灵活。这个镜像支持使用自定义配置文件，可以将宿主目录挂在到容器中，看上去不错。我之发现了一点：如果我使用docker kill停止容器，MySQL服务程序会崩溃。如果需要关闭干净地关闭实例，不得不在容器中停止MySQL服务，之后才能关闭容器。
</p>

<blockquote>
<p>
[root@db-dev.bfc /home/banyek/conf]# docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
e791b3728ab5 percona "/docker-entrypoint.s" 3 minutes ago Up 3 minutes 0.0.0.0:3306-&gt;3306/tcp mysql-dev
[root@db-dev.bfc /home/banyek/conf]# docker exec e791b3728ab5 killall mysqld
[root@db-dev.bfc /home/banyek/conf]# docker rm e791b3728ab5
e791b3728ab5
</p>
</blockquote>

<p>
第一次试验使用开发服务器上的docker容器替代本地MySQL服务器，非常好。我启动数据库实力，将数据目录和binlog目录挂在到容器，并在容器中修改配置文件
</p>
<blockquote>
<p>
[root@db-dev.bfc /home/banyek/conf]# docker run &#x2013;name mysql-dev -v /home/banyek/conf:/etc/mysql/conf.d -v /var/lib/mysql:/var/lib/mysql -v /var/log/mysql:/var/log/mysql -p 3306:3306 -d percona
954360158d7a5c2e050b7049c73a8a098b550da6e3d2e336b43bd690e34e9738
[root@db-dev.bfc /home/banyek/conf]# docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
954360158d7a percona "/docker-entrypoint.s" 7 seconds ago Up 6 seconds 0.0.0.0:3306-&gt;3306/tcp mysql-dev
[root@db-dev.bfc /home/banyek/conf]# mysql -h 127.0.0.1
Welcome to the MySQL monitor. Commands end with ; or \g.
[&#x2026;]
percona@db-dev.bfc.kinja-ops.com (127.0.0.1) [(none)]&gt;
</p>
</blockquote>

<p>
这里只有意见值得担忧的事：本地连接来自docker0网络接口，必须将其IP地址加入放行主机清单。
</p>


<p>
这个实例可以被用在任何应用，可以作为复制链的一部分。
</p>

<p>
当我在测试环境使用了容器化的MySQL，我决定使用sysbench进行性能基准测试。
</p>

<p>
我推荐使用0.5版本，因为0.4.12版本不支持对数据库进行并行性能基准测试，这使得你的测试结果不能同实际使用场景比较。编译sysbench之后，哦我们可以开始测试。
</p>

<p>
在测试中我手动建立了数据库sbtest（在MySQL命令create database sbtest）并且使用下面的命令填充数据
</p>
<blockquote>
<p>
./sysbench &#x2013;test=tests/db/parallel<sub>prepare.lua</sub> &#x2013;mysql<sub>host</sub>=127.0.0.1 &#x2013;mysql-user=XXX &#x2013;mysql-password=YYY &#x2013;oltp-tables-count=64 &#x2013;num-threads=8 run
</p>
</blockquote>


<blockquote>
<p>
#and the tests were ran with the following command:
</p>

<p>
./sysbench &#x2013;test=tests/db/oltp.lua &#x2013;mysql<sub>host</sub>=127.0.0.1 &#x2013;mysql-user=XXX &#x2013;mysql-password=YYY &#x2013;oltp-tables-count=64 &#x2013;num-threads=8 &#x2013;max-time=60 run
</p>
</blockquote>

<p>
我分别对本地MySQL和容器化MySQL进行了3次测试，我记录了最后一次的结果，为了避免
</p>

<blockquote>
<p>
Running the test with following options:
Number of threads: 8
Random number generator seed is 0 and will be ignored
</p>


<p>
Threads started!
</p>

<p>
OLTP test statistics:
 queries performed:
 read: 140140
 write: 40040
 other: 20020
 total: 200200
 transactions: 10010 (1928.10 per sec.)
 read/write requests: 180180 (34705.80 per sec.)
 other operations: 20020 (3856.20 per sec.)
 ignored errors: 0 (0.00 per sec.)
 reconnects: 0 (0.00 per sec.)
</p>

<p>
General statistics:
 total time: 5.1916s
 total number of events: 10010
 total time taken by event execution: 41.4529s
 response time:
 min: 2.97ms
 avg: 4.14ms
 max: 15.98ms
 approx. 95 percentile: 5.34ms
</p>

<p>
Threads fairness:
 events (avg/stddev): 1251.2500/43.21
 execution time (avg/stddev): 5.1816/0.00
</p>
</blockquote>

<p>
这里是容器话的结果。
</p>

<blockquote>
<p>
Threads started!
OLTP test statistics:
 queries performed:
 read: 140000
 write: 40000
 other: 20000
 total: 200000
 transactions: 10000 (1127.79 per sec.)
 read/write requests: 180000 (20300.19 per sec.)
 other operations: 20000 (2255.58 per sec.)
 ignored errors: 0 (0.00 per sec.)
 reconnects: 0 (0.00 per sec.)
General statistics:
 total time: 8.8669s
 total number of events: 10000
 total time taken by event execution: 70.8362s
 response time:
 min: 4.52ms
 avg: 7.08ms
 max: 22.28ms
 approx. 95 percentile: 9.14ms
Threads fairness:
 events (avg/stddev): 1250.0000/60.86
 execution time (avg/stddev): 8.8545/0.00
</p>
</blockquote>

<p>
测试结果令人失望。MySQL在容器中的性能表现大致为本地MySQL的1/2到2/3，这是不可接受的。
</p>

<p>
I started the container with the following command, so it is possible that we can avoid this performance overhead by mounting the data directory more smart (directly from LVM? With some magic mount parameters?) but so far the results are these, and the verdict is “it is not the best idea”.
</p>
<blockquote>
<p>
[root@db-dev.bfc /home/banyek]# docker run &#x2013;name mysql-dev -v /home/banyek/conf:/etc/mysql/conf.d -v /var/lib/mysql:/var/lib/mysql -v /var/log/mysql:/var/log/mysql -p 3306:3306 -d percona
</p>
</blockquote>

<p>
我将检查其他选项和性能调优。
</p>

<p>
星期六在我喜欢的食杂店，排队时yyong d
</p>

<blockquote>
<p>
OLTP test statistics:
 queries performed:
 read: 140182
 write: 40052
 other: 20026
 total: 200260
 transactions: 10013 (1939.54 per sec.)
 read/write requests: 180234 (34911.72 per sec.)
 other operations: 20026 (3879.08 per sec.)
 ignored errors: 0 (0.00 per sec.)
 reconnects: 0 (0.00 per sec.)
</p>

<p>
General statistics:
 total time: 5.1626s
 total number of events: 10013
 total time taken by event execution: 41.2134s
 response time:
 min: 2.96ms
 avg: 4.12ms
 max: 38.07ms
 approx. 95 percentile: 5.21ms
</p>

<p>
Threads fairness:
 events (avg/stddev): 1251.6250/41.54
 execution time (avg/stddev): 5.1517/0.00
</p>
</blockquote>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2019-09-23 周一 18:45</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
